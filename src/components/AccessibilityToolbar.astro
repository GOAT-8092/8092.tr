---
import { getCurrentLanguage, getTranslation, getTranslations } from '../lib/i18n';
import { translations } from '../lib/translations';

const currentLang = getCurrentLanguage(Astro);
const t = (key: string) => getTranslation(translations, currentLang, key);
const translationsObj = getTranslations(currentLang);
const accessibility = translationsObj.accessibility ?? {};
const accessibilitySections = accessibility.sections ?? {};
const accessibilityButtons = accessibility.buttons ?? {};
// Unused variables removed
// accessibilityScriptStrings removed as unused
---

<div id="accessibility-toolbar" class="accessibility-toolbar" role="toolbar" aria-label={t('accessibility.toolbar_label')}>
  <button
    id="a11y-toggle"
    class="a11y-toggle"
    aria-expanded="false"
    aria-controls="a11y-panel"
    title={t('accessibility.toggle_title')}
  >
    <i class="fas fa-universal-access" aria-hidden="true"></i>
    <span class="sr-only">{t('accessibility.toolbar_label')}</span>
  </button>

  <div id="a11y-panel" class="a11y-panel hidden" role="region" aria-labelledby="a11y-title">
    <div class="a11y-header">
      <h3 id="a11y-title" class="a11y-title">
        <i class="fas fa-universal-access mr-2" aria-hidden="true"></i>
        {t('accessibility.panel_title')}
      </h3>
      <button id="a11y-close" class="a11y-close" aria-label={t('accessibility.close_label')}>
        <i class="fas fa-times" aria-hidden="true"></i>
      </button>
    </div>

    <div class="a11y-content">
      <!-- Font Size Controls -->
      <div class="a11y-section">
        <h4 class="a11y-section-title">{accessibilitySections.fontSize ?? ''}</h4>
        <div class="a11y-controls" role="group" aria-labelledby="font-size-controls">
          <button class="a11y-btn" data-action="font-size" data-value="decrease" aria-label={accessibilityButtons.font_decrease_label ?? ''}>
            <i class="fas fa-minus" aria-hidden="true"></i> {accessibilityButtons.font_decrease ?? 'A-'}
          </button>
          <button class="a11y-btn" data-action="font-size" data-value="reset" aria-label={accessibilityButtons.font_reset_label ?? ''}>
            <i class="fas fa-redo" aria-hidden="true"></i> {accessibilityButtons.font_reset ?? 'A'}
          </button>
          <button class="a11y-btn" data-action="font-size" data-value="increase" aria-label={accessibilityButtons.font_increase_label ?? ''}>
            <i class="fas fa-plus" aria-hidden="true"></i> {accessibilityButtons.font_increase ?? 'A+'}
          </button>
        </div>
      </div>

      <!-- Contrast Controls -->
      <div class="a11y-section">
        <h4 class="a11y-section-title">{accessibilitySections.contrast ?? ''}</h4>
        <div class="a11y-controls">
          <button class="a11y-btn" data-action="contrast" data-value="high" aria-label={accessibilityButtons.high_contrast_label ?? ''}>
            <i class="fas fa-adjust" aria-hidden="true"></i> {accessibilityButtons.high_contrast ?? ''}
          </button>
          <button class="a11y-btn" data-action="contrast" data-value="reset" aria-label={accessibilityButtons.normal_contrast_label ?? ''}>
            <i class="fas fa-eye" aria-hidden="true"></i> {accessibilityButtons.normal_contrast ?? ''}
          </button>
        </div>
      </div>

      <!-- Reading Tools -->
      <div class="a11y-section">
        <h4 class="a11y-section-title">{accessibilitySections.reading ?? ''}</h4>
        <div class="a11y-controls">
          <button class="a11y-btn" data-action="reading-guide" aria-label={accessibilityButtons.reading_guide_label ?? ''}>
            <i class="fas fa-grip-lines" aria-hidden="true"></i> {accessibilityButtons.reading_guide ?? ''}
          </button>
          <button class="a11y-btn" data-action="focus-outline" aria-label={accessibilityButtons.focus_outline_label ?? ''}>
            <i class="fas fa-square" aria-hidden="true"></i> {accessibilityButtons.focus_outline ?? ''}
          </button>
        </div>
      </div>

      <!-- Motion Controls -->
      <div class="a11y-section">
        <h4 class="a11y-section-title">{accessibilitySections.motion ?? ''}</h4>
        <div class="a11y-controls">
          <button class="a11y-btn" data-action="reduce-motion" aria-label={accessibilityButtons.reduce_motion_label ?? ''}>
            <i class="fas fa-pause" aria-hidden="true"></i> {accessibilityButtons.reduce_motion ?? ''}
          </button>
          <button class="a11y-btn" data-action="reset-motion" aria-label={accessibilityButtons.reset_motion_label ?? ''}>
            <i class="fas fa-play" aria-hidden="true"></i> {accessibilityButtons.reset_motion ?? ''}
          </button>
        </div>
      </div>

      <!-- Skip Links -->
      <div class="a11y-section">
        <h4 class="a11y-section-title">{accessibilitySections.shortcuts ?? ''}</h4>
        <div class="a11y-controls">
          <a href="#takim" class="a11y-btn" role="button">
            <i class="fas fa-users" aria-hidden="true"></i> {accessibilityButtons.shortcut_team ?? ''}
          </a>
          <a href="#galeri" class="a11y-btn" role="button">
            <i class="fas fa-images" aria-hidden="true"></i> {accessibilityButtons.shortcut_gallery ?? ''}
          </a>
          <a href="#iletisim" class="a11y-btn" role="button">
            <i class="fas fa-envelope" aria-hidden="true"></i> {accessibilityButtons.shortcut_contact ?? ''}
          </a>
        </div>
      </div>

      <!-- Reset All -->
      <div class="a11y-section">
        <button class="a11y-btn a11y-reset" data-action="reset-all" aria-label={accessibilityButtons.reset_all_label ?? ''}>
          <i class="fas fa-undo" aria-hidden="true"></i> {accessibilityButtons.reset_all ?? ''}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reading Guide -->
<div id="reading-guide" class="reading-guide hidden" aria-hidden="true"></div>

<style>
  .accessibility-toolbar {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
  }

  .a11y-toggle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #512f75;
    color: white;
    border: 2px solid transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
  }

  .a11y-toggle:hover, .a11y-toggle:focus {
    background: #673a8e;
    transform: scale(1.1);
    border-color: #7e46a8;
  }

  .a11y-panel {
    position: absolute;
    top: 60px;
    right: 0;
    width: 320px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    border: 1px solid #e5e7eb;
    overflow: hidden;
    transform: translateY(-10px) scale(0.95);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  .a11y-panel.show {
    transform: translateY(0) scale(1);
    opacity: 1;
  }

  .a11y-header {
    background: linear-gradient(135deg, #512f75, #673a8e);
    color: white;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .a11y-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
  }

  .a11y-close {
    background: none;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.8;
    transition: all 0.2s ease;
  }

  .a11y-close:hover, .a11y-close:focus {
    opacity: 1;
    background: rgba(255, 255, 255, 0.1);
  }

  .a11y-content {
    padding: 16px;
    max-height: 400px;
    overflow-y: auto;
  }

  .a11y-section {
    margin-bottom: 20px;
  }

  .a11y-section:last-child {
    margin-bottom: 0;
  }

  .a11y-section-title {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin: 0 0 8px 0;
  }

  .a11y-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .a11y-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .a11y-btn:hover, .a11y-btn:focus {
    background: #e5e7eb;
    border-color: #9ca3af;
    transform: translateY(-1px);
  }

  .a11y-btn.active {
    background: #512f75;
    color: white;
    border-color: #512f75;
  }

  .a11y-reset {
    background: #fee2e2;
    color: #dc2626;
    border-color: #fecaca;
    width: 100%;
    justify-content: center;
  }

  .a11y-reset:hover, .a11y-reset:focus {
    background: #fecaca;
    border-color: #f87171;
  }

  .reading-guide {
    position: fixed;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #512f75, #7e46a8);
    z-index: 9998;
    box-shadow: 0 0 10px rgba(81, 47, 117, 0.5);
    pointer-events: none;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .hidden {
    display: none !important;
  }

  /* Accessibility states */
  body.high-contrast {
    filter: contrast(150%) brightness(1.2);
  }

  body.reduce-motion * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }

  body.font-large {
    font-size: 125%;
  }

  body.font-xl {
    font-size: 150%;
  }

  body.enhanced-focus *:focus {
    outline: 3px solid #7e46a8 !important;
    outline-offset: 2px !important;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .accessibility-toolbar {
      top: 16px;
      right: 16px;
    }

    .a11y-panel {
      width: 280px;
      right: -140px;
      left: auto;
      transform: translateX(140px) translateY(-10px) scale(0.95);
    }

    .a11y-panel.show {
      transform: translateX(140px) translateY(0) scale(1);
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .a11y-toggle {
      border: 3px solid white;
    }

    .a11y-panel {
      border: 2px solid black;
    }

    .a11y-btn {
      border: 2px solid black;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .a11y-panel {
      background: #1f2937;
      border-color: #374151;
    }

    .a11y-section-title {
      color: #f9fafb;
    }

    .a11y-btn {
      background: #374151;
      color: #f9fafb;
      border-color: #4b5563;
    }

    .a11y-btn:hover, .a11y-btn:focus {
      background: #4b5563;
    }
  }
</style>

<script is:inline>
  // Define strings directly in the script since Astro frontmatter variables aren't accessible in inline scripts
  const accessibilityStrings = {
    announcements: {
      fontSizeIncreased: "Yazı boyutu büyütüldü",
      fontSizeDecreased: "Yazı boyutu küçültüldü",
      fontSizeReset: "Yazı boyutu normal boyuta ayarlandı",
      highContrastEnabled: "Yüksek kontrast modu etkinleştirildi",
      highContrastDisabled: "Yüksek kontrast modu devre dışı bırakıldı",
      readingGuideEnabled: "Okuma kılavuzu etkinleştirildi",
      readingGuideDisabled: "Okuma kılavuzu devre dışı bırakıldı",
      focusOutlineEnabled: "Odak vurgusu güçlendirildi",
      focusOutlineDisabled: "Odak vurgusu normal ayara döndü",
      motionReduced: "Animasyonlar azaltıldı",
      motionReset: "Animasyonlar normale döndü",
      allSettingsReset: "Tüm erişilebilirlik ayarları sıfırlandı"
    },
    font_states: {
      normal: "Normal",
      large: "Büyük",
      xl: "Çok Büyük"
    }
  };

  class AccessibilityManager {
    constructor(strings) {
      // Debug log removed
      this.panel = null;
      this.toggle = null;
      this.readingGuide = null;
      this.isOpen = false;
      this.strings = strings;
      this.settings = {
        fontSize: 'normal',
        contrast: 'normal',
        motion: 'normal',
        readingGuide: false,
        focusOutline: false,
      };

      this.init();
    }

    init() {
      this.panel = document.getElementById('a11y-panel');
      this.toggle = document.getElementById('a11y-toggle');
      this.readingGuide = document.getElementById('reading-guide');

      if (!this.panel || !this.toggle) {
        console.warn('AccessibilityManager: Required DOM elements not found', {
          panel: !!this.panel,
          toggle: !!this.toggle,
          readingGuide: !!this.readingGuide
        });
        return;
      }

      this.loadSettings();
      this.applySettings();

      this.toggle.addEventListener('click', () => this.togglePanel());
      const closeButton = document.getElementById('a11y-close');
      if (closeButton) {
        closeButton.addEventListener('click', () => this.closePanel());
      }

      this.panel.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }

        const button = target.closest('[data-action]');
        if (!button) {
          return;
        }

        const action = button.getAttribute('data-action');
        const value = button.getAttribute('data-value');
        if (action) {
          this.handleAction(action, value);
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && this.isOpen) {
          this.closePanel();
        }
      });

      document.addEventListener('click', (event) => {
        if (!this.isOpen || !this.panel || !this.toggle) {
          return;
        }

        const target = event.target;
        if (target instanceof Node && !this.panel.contains(target) && !this.toggle.contains(target)) {
          this.closePanel();
        }
      });

      document.addEventListener('mousemove', (event) => {
        if (this.settings.readingGuide && this.readingGuide) {
          this.readingGuide.style.top = `${event.clientY}px`;
        }
      });

      this.announceAccessibility();
      // Debug log removed
    }

    togglePanel() {
      // Debug log removed
      if (this.isOpen) {
        this.closePanel();
      } else {
        this.openPanel();
      }
    }

    openPanel() {
      if (!this.panel || !this.toggle) {
        return;
      }

      this.panel.classList.remove('hidden');
      setTimeout(() => {
        if (this.panel) {
          this.panel.classList.add('show');
        }
      }, 10);

      this.toggle.setAttribute('aria-expanded', 'true');
      this.isOpen = true;

      const firstButton = this.panel.querySelector('button, a');
      if (firstButton instanceof HTMLElement) {
        firstButton.focus();
      }
    }

    closePanel() {
      if (!this.panel || !this.toggle) {
        return;
      }

      this.panel.classList.remove('show');
      setTimeout(() => {
        if (this.panel) {
          this.panel.classList.add('hidden');
        }
      }, 300);

      this.toggle.setAttribute('aria-expanded', 'false');
      this.isOpen = false;
      this.toggle.focus();
    }

    handleAction(action, value) {
      switch (action) {
        case 'font-size':
          this.adjustFontSize(value);
          break;
        case 'contrast':
          this.adjustContrast(value);
          break;
        case 'reading-guide':
          this.toggleReadingGuide();
          break;
        case 'focus-outline':
          this.toggleFocusOutline();
          break;
        case 'reduce-motion':
          this.reduceMotion();
          break;
        case 'reset-motion':
          this.resetMotion();
          break;
        case 'reset-all':
          this.resetAll();
          break;
        default:
          break;
      }

      this.saveSettings();
      this.updateButtonStates();
    }

    adjustFontSize(action) {
      document.body.classList.remove('font-large', 'font-xl');

      if (action === 'increase') {
        if (this.settings.fontSize === 'normal') {
          this.settings.fontSize = 'large';
          document.body.classList.add('font-large');
        } else if (this.settings.fontSize === 'large') {
          this.settings.fontSize = 'xl';
          document.body.classList.add('font-xl');
        }
      } else if (action === 'decrease') {
        if (this.settings.fontSize === 'xl') {
          this.settings.fontSize = 'large';
          document.body.classList.add('font-large');
        } else if (this.settings.fontSize === 'large') {
          this.settings.fontSize = 'normal';
        }
      } else if (action === 'reset') {
        this.settings.fontSize = 'normal';
      }

      this.announceFontSize();
    }

    adjustContrast(value) {
      const isHigh = value === 'high';
      document.body.classList.toggle('high-contrast', isHigh);
      this.settings.contrast = value || 'normal';

      const message = isHigh
        ? this.strings.announcements?.contrast_high
        : this.strings.announcements?.contrast_normal;
      this.announceChange(message || '');
    }

    toggleReadingGuide() {
      this.settings.readingGuide = !this.settings.readingGuide;

      if (this.readingGuide) {
        this.readingGuide.classList.toggle('hidden', !this.settings.readingGuide);
        this.readingGuide.setAttribute('aria-hidden', (!this.settings.readingGuide).toString());
      }

      const message = this.settings.readingGuide
        ? this.strings.announcements?.reading_on
        : this.strings.announcements?.reading_off;
      this.announceChange(message || '');
    }

    toggleFocusOutline() {
      this.settings.focusOutline = !this.settings.focusOutline;
      document.body.classList.toggle('enhanced-focus', this.settings.focusOutline);

      const message = this.settings.focusOutline
        ? this.strings.announcements?.focus_on
        : this.strings.announcements?.focus_off;
      this.announceChange(message || '');
    }

    reduceMotion() {
      this.settings.motion = 'reduced';
      document.body.classList.add('reduce-motion');
      this.announceChange(this.strings.announcements?.motion_reduced || '');
    }

    resetMotion() {
      this.settings.motion = 'normal';
      document.body.classList.remove('reduce-motion');
      this.announceChange(this.strings.announcements?.motion_normal || '');
    }

    resetAll() {
      this.settings = {
        fontSize: 'normal',
        contrast: 'normal',
        motion: 'normal',
        readingGuide: false,
        focusOutline: false,
      };

      this.applySettings();
      this.announceChange(this.strings.announcements?.reset_all || '');
    }

    applySettings() {
      document.body.classList.remove('font-large', 'font-xl');
      if (this.settings.fontSize === 'large') {
        document.body.classList.add('font-large');
      } else if (this.settings.fontSize === 'xl') {
        document.body.classList.add('font-xl');
      }

      document.body.classList.toggle('high-contrast', this.settings.contrast === 'high');
      document.body.classList.toggle('reduce-motion', this.settings.motion === 'reduced');
      document.body.classList.toggle('enhanced-focus', this.settings.focusOutline);

      if (this.readingGuide) {
        this.readingGuide.classList.toggle('hidden', !this.settings.readingGuide);
      }

      this.updateButtonStates();
    }

    updateButtonStates() {
      if (!this.panel) {
        return;
      }

      const buttons = this.panel.querySelectorAll('[data-action]');
      buttons.forEach((button) => {
        button.classList.remove('active');
      });

      if (this.settings.contrast === 'high') {
        const btn = this.panel.querySelector('[data-action="contrast"][data-value="high"]');
        btn?.classList.add('active');
      }
      if (this.settings.readingGuide) {
        const btn = this.panel.querySelector('[data-action="reading-guide"]');
        btn?.classList.add('active');
      }
      if (this.settings.focusOutline) {
        const btn = this.panel.querySelector('[data-action="focus-outline"]');
        btn?.classList.add('active');
      }
      if (this.settings.motion === 'reduced') {
        const btn = this.panel.querySelector('[data-action="reduce-motion"]');
        btn?.classList.add('active');
      }
    }

    saveSettings() {
      try {
        localStorage.setItem('accessibility-settings', JSON.stringify(this.settings));
      } catch (error) {
        console.warn('Could not save accessibility settings', error);
      }
    }

    loadSettings() {
      try {
        const saved = localStorage.getItem('accessibility-settings');
        if (saved) {
          const parsed = JSON.parse(saved);
          this.settings = { ...this.settings, ...parsed };
        }
      } catch (error) {
        console.warn('Could not load accessibility settings', error);
      }
    }

    announceChange(message) {
      if (!message) {
        return;
      }

      const announcement = document.createElement('div');
      announcement.setAttribute('aria-live', 'polite');
      announcement.setAttribute('aria-atomic', 'true');
      announcement.className = 'sr-only';
      announcement.textContent = message;

      document.body.appendChild(announcement);

      setTimeout(() => {
        announcement.remove();
      }, 1000);
    }

    announceAccessibility() {
      setTimeout(() => {
        this.announceChange(this.strings.announcements?.intro || '');
      }, 2000);
    }

    announceFontSize() {
      const template = this.strings.announcements?.font_size;
      const stateKey = this.settings.fontSize;
      const stateLabel = this.strings.font_states?.[stateKey] || stateKey;
      this.announceChange(this.formatAnnouncement(template, { state: stateLabel }));
    }

    formatAnnouncement(template, params = {}) {
      if (!template) {
        return '';
      }

      return template.replace(/\{\{(.*?)\}\}/g, (_, key) => {
        const lookup = key.trim();
        return Object.prototype.hasOwnProperty.call(params, lookup) ? params[lookup] : '';
      });
    }
  }

  // More robust initialization
  function initializeAccessibility() {
    try {
      new AccessibilityManager(accessibilityStrings);
    } catch (error) {
      console.error('AccessibilityManager initialization error:', error);
      // Retry after a short delay
      setTimeout(initializeAccessibility, 100);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAccessibility);
  } else {
    // DOM already loaded, initialize immediately
    initializeAccessibility();
  }

  document.addEventListener('keydown', (event) => {
    if (event.altKey && event.key === '1') {
      event.preventDefault();
      const main = document.querySelector('main') || document.querySelector('#anasayfa');
      if (main instanceof HTMLElement) {
        main.focus();
      }
    }

    if (event.altKey && event.key === '2') {
      event.preventDefault();
      const nav = document.querySelector('nav') || document.querySelector('.navigation');
      if (nav instanceof HTMLElement) {
        nav.focus();
      }
    }

    if (event.altKey && event.key === '3') {
      event.preventDefault();
      const search = document.querySelector('[type="search"]') || document.querySelector('#search');
      if (search instanceof HTMLElement) {
        search.focus();
      }
    }
  });
</script>
